<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç†ï¼†å†™çœŸãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <style>
        :root {
            --primary-color: #0066CC;
            --primary-hover: #0052A3;
            --bg-color: #FFFFFF;
            --text-color: #1F2937;
            --border-color: #D1D5DB;
            --light-bg: #E5E7EB;
            --success-color: #10B981;
            --error-color: #DC2626;
            --vip-color: #FFB800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 24px 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        main {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-btn {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6B7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box button {
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .search-box button:hover {
            background-color: var(--primary-hover);
        }

        .filter-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background-color: var(--light-bg);
            border-radius: 6px;
        }

        .filter-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .filter-container label {
            cursor: pointer;
            font-size: 14px;
        }

        .customer-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-card:hover {
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
            transform: translateY(-2px);
        }

        .customer-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .customer-name {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vip-badge {
            color: var(--vip-color);
            font-size: 18px;
        }

        .visit-count {
            font-size: 12px;
            color: #6B7280;
            background-color: var(--light-bg);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .customer-info {
            font-size: 13px;
            color: #6B7280;
            margin: 4px 0;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--light-bg);
            color: var(--text-color);
            flex: 1;
        }

        .btn-secondary:hover {
            background-color: #D1D5DB;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
            flex: 0.5;
        }

        .btn-danger:hover {
            background-color: #991B1B;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            width: 100%;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .required {
            color: var(--error-color);
        }

        .purchase-item {
            background-color: var(--light-bg);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .purchase-item:hover {
            background-color: #D1D5DB;
        }

        .purchase-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .purchase-date {
            font-weight: 600;
            color: var(--text-color);
        }

        .purchase-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .purchase-product {
            font-size: 13px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .purchase-photos {
            font-size: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .gallery-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .gallery-item {
            position: relative;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 6px;
            cursor: pointer;
            background-color: var(--light-bg);
        }

        .gallery-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-counter {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            padding: 16px;
            overflow-y: auto;
        }

        .lightbox.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            max-width: 90vw;
            max-height: 90vh;
            text-align: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            margin-bottom: 16px;
            border-radius: 8px;
        }

        .lightbox-info {
            color: white;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .lightbox-close {
            color: white;
            font-size: 32px;
            position: absolute;
            top: 16px;
            right: 16px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 16px;
            color: #6B7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .back-button:hover {
            color: var(--primary-hover);
        }

        .detail-header {
            background-color: var(--light-bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .detail-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .detail-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 13px;
        }

        .detail-info-item {
            display: flex;
            flex-direction: column;
        }

        .detail-info-label {
            color: #6B7280;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-info-value {
            color: var(--text-color);
            font-weight: 600;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
            color: var(--text-color);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background-color: #FEE2E2;
            color: #7F1D1D;
            border: 1px solid #FECACA;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6B7280;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--light-bg);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .date-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .date-input-group input {
            width: 100%;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: var(--light-bg);
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        @media (max-width: 480px) {
            .detail-info {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“± é¡§å®¢ç®¡ç†ï¼†å†™çœŸ</h1>
            <p>å°å£²åº—å‘ã‘é¡§å®¢æƒ…å ±ï¼†è³¼å…¥å†™çœŸã‚¢ãƒ—ãƒª</p>
        </header>

        <main>
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆé¡§å®¢ä¸€è¦§ï¼‰ -->
            <div id="homeScreen" class="screen active">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('home')">ğŸ“‹ é¡§å®¢ä¸€è¦§</button>
                    <button class="tab-btn" onclick="switchTab('search')">ğŸ” æ¤œç´¢</button>
                    <button class="tab-btn" onclick="switchTab('vip')">â­ VIP</button>
                </div>

                <div class="search-box">
                    <input type="text" id="homeSearch" placeholder="é¡§å®¢åã§æ¤œç´¢..." />
                    <button onclick="searchCustomers()">æ¤œç´¢</button>
                </div>

                <div class="form-group">
                    <label>æ ¡åãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
                    <select id="schoolFilter" onchange="applyFilters()">
                        <option value="">ã™ã¹ã¦ã®æ ¡</option>
                        <option value="åå¤å±‹20">åå¤å±‹20</option>
                        <option value="é™å²¡15">é™å²¡15</option>
                        <option value="æµœæ¾17">æµœæ¾17</option>
                        <option value="è±Šæ©‹18">è±Šæ©‹18</option>
                        <option value="æ¸‹è°·20">æ¸‹è°·20</option>
                        <option value="æ± è¢‹21">æ± è¢‹21</option>
                        <option value="éŒ¦ç³¸ç”º22">éŒ¦ç³¸ç”º22</option>
                        <option value="è’²ç”°23">è’²ç”°23</option>
                        <option value="ç”ºç”°24">ç”ºç”°24</option>
                        <option value="å‰ç¥¥å¯º25">å‰ç¥¥å¯º25</option>
                        <option value="ç«‹å·26">ç«‹å·26</option>
                        <option value="å…«ç‹å­27">å…«ç‹å­27</option>
                        <option value="æœ¬åšæœ¨28">æœ¬åšæœ¨28</option>
                        <option value="æ–°å®¿29">æ–°å®¿29</option>
                        <option value="æ¨ªæµœ30">æ¨ªæµœ30</option>
                        <option value="ä¸Šå¤§å²¡31">ä¸Šå¤§å²¡31</option>
                        <option value="è—¤æ²¢32">è—¤æ²¢32</option>
                        <option value="æ¨ªé ˆè³€33">æ¨ªé ˆè³€33</option>
                        <option value="èˆ¹æ©‹34">èˆ¹æ©‹34</option>
                        <option value="åƒè‘‰35">åƒè‘‰35</option>
                        <option value="å¹³å¡š37">å¹³å¡š37</option>
                        <option value="å¤§å®®40">å¤§å®®40</option>
                        <option value="å·è¶Š44">å·è¶Š44</option>
                        <option value="æ‰€æ²¢46">æ‰€æ²¢46</option>
                        <option value="æŸ63">æŸ63</option>
                        <option value="æºã®å£67">æºã®å£67</option>
                        <option value="æ­¦è”µå°æ‰68">æ­¦è”µå°æ‰68</option>
                        <option value="æœ¬éƒ¨90">æœ¬éƒ¨90</option>
                    </select>
                </div>

                <div class="filter-container">
                    <input type="checkbox" id="vipFilter" onchange="applyFilters()" />
                    <label for="vipFilter">VIPé¡§å®¢ã®ã¿è¡¨ç¤º</label>
                </div>

                <div class="filter-container">
                    <input type="checkbox" id="tsumugiFilter" onchange="applyFilters()" />
                    <label for="tsumugiFilter">ç´¬å¥½ãã®ã¿è¡¨ç¤º</label>
                </div>

                <div id="customerList"></div>

                <div class="button-group" style="flex-direction: column; gap: 8px;">
                    <button class="btn btn-primary btn-large" onclick="showScreen('newCustomerScreen')">
                        â• æ–°è¦é¡§å®¢ç™»éŒ²
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="showScreen('toolsScreen')">
                        ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ï¼†è¨­å®š
                    </button>
                </div>
            </div>

            <!-- æ–°è¦é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="newCustomerScreen" class="screen">
                <button class="back-button" onclick="showScreen('homeScreen')">â† æˆ»ã‚‹</button>
                <h2>æ–°è¦é¡§å®¢ç™»éŒ²</h2>

                <div class="form-group">
                    <label>é¡§å®¢å <span class="required">*</span></label>
                    <input type="text" id="newCustomerName" placeholder="ä¾‹ï¼šç”°ä¸­å¤ªéƒ" />
                </div>

                <div class="form-group">
                    <label>é›»è©±ç•ªå·</label>
                    <input type="tel" id="newCustomerPhone" placeholder="ä¾‹ï¼š09012345678" />
                </div>

                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="newCustomerEmail" placeholder="ä¾‹ï¼štanaka@example.com" />
                </div>

                <div class="form-group">
                    <label>æ ¡å</label>
                    <select id="newCustomerSchool">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="åå¤å±‹20">åå¤å±‹20</option>
                        <option value="é™å²¡15">é™å²¡15</option>
                        <option value="æµœæ¾17">æµœæ¾17</option>
                        <option value="è±Šæ©‹18">è±Šæ©‹18</option>
                        <option value="æ¸‹è°·20">æ¸‹è°·20</option>
                        <option value="æ± è¢‹21">æ± è¢‹21</option>
                        <option value="éŒ¦ç³¸ç”º22">éŒ¦ç³¸ç”º22</option>
                        <option value="è’²ç”°23">è’²ç”°23</option>
                        <option value="ç”ºç”°24">ç”ºç”°24</option>
                        <option value="å‰ç¥¥å¯º25">å‰ç¥¥å¯º25</option>
                        <option value="ç«‹å·26">ç«‹å·26</option>
                        <option value="å…«ç‹å­27">å…«ç‹å­27</option>
                        <option value="æœ¬åšæœ¨28">æœ¬åšæœ¨28</option>
                        <option value="æ–°å®¿29">æ–°å®¿29</option>
                        <option value="æ¨ªæµœ30">æ¨ªæµœ30</option>
                        <option value="ä¸Šå¤§å²¡31">ä¸Šå¤§å²¡31</option>
                        <option value="è—¤æ²¢32">è—¤æ²¢32</option>
                        <option value="æ¨ªé ˆè³€33">æ¨ªé ˆè³€33</option>
                        <option value="èˆ¹æ©‹34">èˆ¹æ©‹34</option>
                        <option value="åƒè‘‰35">åƒè‘‰35</option>
                        <option value="å¹³å¡š37">å¹³å¡š37</option>
                        <option value="å¤§å®®40">å¤§å®®40</option>
                        <option value="å·è¶Š44">å·è¶Š44</option>
                        <option value="æ‰€æ²¢46">æ‰€æ²¢46</option>
                        <option value="æŸ63">æŸ63</option>
                        <option value="æºã®å£67">æºã®å£67</option>
                        <option value="æ­¦è”µå°æ‰68">æ­¦è”µå°æ‰68</option>
                        <option value="æœ¬éƒ¨90">æœ¬éƒ¨90</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ‰€å±</label>
                    <select id="newCustomerAffiliation">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å­¦é™¢">å­¦é™¢</option>
                        <option value="ã—ã‚…ã†ç¾ä¼š">ã—ã‚…ã†ç¾ä¼š</option>
                        <option value="è¬›å¸«">è¬›å¸«</option>
                        <option value="å¾“æ¥­å“¡">å¾“æ¥­å“¡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä¿®ç§‘ï¼ˆåˆ†é¡ï¼‰ <span class="required">*</span></label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <select id="newCustomerCategory" style="flex: 1;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å°‚æ”»ç§‘">å°‚æ”»ç§‘</option>
                            <option value="å¸«ç¯„ç§‘">å¸«ç¯„ç§‘</option>
                            <option value="çµŒå–¶å¸«ç¯„ç§‘">çµŒå–¶å¸«ç¯„ç§‘</option>
                            <option value="ç ”ç©¶ç§‘">ç ”ç©¶ç§‘</option>
                            <option value="ç ”ç©¶å°‚ç§‘">ç ”ç©¶å°‚ç§‘</option>
                            <option value="æ•™é¤Šç§‘">æ•™é¤Šç§‘</option>
                            <option value="å­¦ï½¥å‰¯ã‚ªãƒ—">å­¦ï½¥å‰¯ã‚ªãƒ—</option>
                            <option value="ä¸»ä»»ã‚ªãƒ—">ä¸»ä»»ã‚ªãƒ—</option>
                            <option value="è¬›å¸«é¤Šæˆ">è¬›å¸«é¤Šæˆ</option>
                            <option value="ç€ä»˜å¸«é¤Šæˆ">ç€ä»˜å¸«é¤Šæˆ</option>
                            <option value="ãã¤ã‘èˆ">ãã¤ã‘èˆ</option>
                            <option value="ãƒ—ãƒ­ç§‘">ãƒ—ãƒ­ç§‘</option>
                            <option value="å’Œè£">å’Œè£</option>
                            <option value="æ‚ éŠè¬›åº§">æ‚ éŠè¬›åº§</option>
                            <option value="åœ°å”„èˆ">åœ°å”„èˆ</option>
                            <option value="ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯">ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯</option>
                            <option value="æŒ¯è¢–å¸¯çµã³">æŒ¯è¢–å¸¯çµã³</option>
                            <option value="æŠ€è¡“æ™®åŠéƒ¨">æŠ€è¡“æ™®åŠéƒ¨</option>
                            <option value="ãƒ—ãƒ­ç€ä»˜é¤Šæˆ">ãƒ—ãƒ­ç€ä»˜é¤Šæˆ</option>
                        </select>
                        <button class="btn btn-secondary" style="width: auto; padding: 8px 12px;" onclick="addCustomCategory()">+ è¿½åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>ãã®ä»–ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
                    <textarea id="newCustomerMemo" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="newCustomerVIP" />
                    <label for="newCustomerVIP">ã“ã®é¡§å®¢ã‚’VIPã«è¨­å®š</label>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveCustomer()">âœ… ç™»éŒ²ã™ã‚‹</button>
                    <button class="btn btn-secondary" onclick="showScreen('homeScreen')">âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>

            <!-- é¡§å®¢è©³ç´°ç”»é¢ -->
            <div id="customerDetailScreen" class="screen">
                <button class="back-button" onclick="showScreen('homeScreen')">â† æˆ»ã‚‹</button>

                <div class="detail-header">
                    <h2 id="detailCustomerName"></h2>
                    <div class="detail-info">
                        <div class="detail-info-item">
                            <div class="detail-info-label">ğŸ“ é›»è©±</div>
                            <div class="detail-info-value" id="detailCustomerPhone"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">ğŸ“§ ãƒ¡ãƒ¼ãƒ«</div>
                            <div class="detail-info-value" id="detailCustomerEmail"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">æ ¡å</div>
                            <div class="detail-info-value" id="detailCustomerSchool"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">æ‰€å±</div>
                            <div class="detail-info-value" id="detailCustomerAffiliation"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">ä¿®ç§‘</div>
                            <div class="detail-info-value" id="detailCustomerCategory"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">æ¥åº—å›æ•°</div>
                            <div class="detail-info-value" id="detailVisitCount"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">æœ€çµ‚æ¥åº—</div>
                            <div class="detail-info-value" id="detailLastVisit"></div>
                        </div>
                        <div class="detail-info-item">
                            <div class="detail-info-label">ç™»éŒ²æ—¥</div>
                            <div class="detail-info-value" id="detailCreatedDate"></div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="editCustomer()">âœï¸ ç·¨é›†</button>
                    <button class="btn btn-danger" onclick="deleteCustomerConfirm()">ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>

                <div id="editCustomerForm" style="display: none; margin-top: 16px;">
                    <h3>é¡§å®¢æƒ…å ±ç·¨é›†</h3>
                    <div class="form-group">
                        <label>é¡§å®¢å <span class="required">*</span></label>
                        <input type="text" id="editCustomerName" />
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" id="editCustomerPhone" />
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="editCustomerEmail" />
                    </div>
                    <div class="form-group">
                        <label>æ ¡å</label>
                        <select id="editCustomerSchool">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="åå¤å±‹20">åå¤å±‹20</option>
                            <option value="é™å²¡15">é™å²¡15</option>
                            <option value="æµœæ¾17">æµœæ¾17</option>
                            <option value="è±Šæ©‹18">è±Šæ©‹18</option>
                            <option value="æ¸‹è°·20">æ¸‹è°·20</option>
                            <option value="æ± è¢‹21">æ± è¢‹21</option>
                            <option value="éŒ¦ç³¸ç”º22">éŒ¦ç³¸ç”º22</option>
                            <option value="è’²ç”°23">è’²ç”°23</option>
                            <option value="ç”ºç”°24">ç”ºç”°24</option>
                            <option value="å‰ç¥¥å¯º25">å‰ç¥¥å¯º25</option>
                            <option value="ç«‹å·26">ç«‹å·26</option>
                            <option value="å…«ç‹å­27">å…«ç‹å­27</option>
                            <option value="æœ¬åšæœ¨28">æœ¬åšæœ¨28</option>
                            <option value="æ–°å®¿29">æ–°å®¿29</option>
                            <option value="æ¨ªæµœ30">æ¨ªæµœ30</option>
                            <option value="ä¸Šå¤§å²¡31">ä¸Šå¤§å²¡31</option>
                            <option value="è—¤æ²¢32">è—¤æ²¢32</option>
                            <option value="æ¨ªé ˆè³€33">æ¨ªé ˆè³€33</option>
                            <option value="èˆ¹æ©‹34">èˆ¹æ©‹34</option>
                            <option value="åƒè‘‰35">åƒè‘‰35</option>
                            <option value="å¹³å¡š37">å¹³å¡š37</option>
                            <option value="å¤§å®®40">å¤§å®®40</option>
                            <option value="å·è¶Š44">å·è¶Š44</option>
                            <option value="æ‰€æ²¢46">æ‰€æ²¢46</option>
                            <option value="æŸ63">æŸ63</option>
                            <option value="æºã®å£67">æºã®å£67</option>
                            <option value="æ­¦è”µå°æ‰68">æ­¦è”µå°æ‰68</option>
                            <option value="æœ¬éƒ¨90">æœ¬éƒ¨90</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ‰€å±</label>
                        <select id="editCustomerAffiliation">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å­¦é™¢">å­¦é™¢</option>
                            <option value="ã—ã‚…ã†ç¾ä¼š">ã—ã‚…ã†ç¾ä¼š</option>
                            <option value="è¬›å¸«">è¬›å¸«</option>
                            <option value="å¾“æ¥­å“¡">å¾“æ¥­å“¡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¿®ç§‘ï¼ˆåˆ†é¡ï¼‰</label>
                        <select id="editCustomerCategory">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å°‚æ”»ç§‘">å°‚æ”»ç§‘</option>
                            <option value="å¸«ç¯„ç§‘">å¸«ç¯„ç§‘</option>
                            <option value="çµŒå–¶å¸«ç¯„ç§‘">çµŒå–¶å¸«ç¯„ç§‘</option>
                            <option value="ç ”ç©¶ç§‘">ç ”ç©¶ç§‘</option>
                            <option value="ç ”ç©¶å°‚ç§‘">ç ”ç©¶å°‚ç§‘</option>
                            <option value="æ•™é¤Šç§‘">æ•™é¤Šç§‘</option>
                            <option value="å­¦ï½¥å‰¯ã‚ªãƒ—">å­¦ï½¥å‰¯ã‚ªãƒ—</option>
                            <option value="ä¸»ä»»ã‚ªãƒ—">ä¸»ä»»ã‚ªãƒ—</option>
                            <option value="è¬›å¸«é¤Šæˆ">è¬›å¸«é¤Šæˆ</option>
                            <option value="ç€ä»˜å¸«é¤Šæˆ">ç€ä»˜å¸«é¤Šæˆ</option>
                            <option value="ãã¤ã‘èˆ">ãã¤ã‘èˆ</option>
                            <option value="ãƒ—ãƒ­ç§‘">ãƒ—ãƒ­ç§‘</option>
                            <option value="å’Œè£">å’Œè£</option>
                            <option value="æ‚ éŠè¬›åº§">æ‚ éŠè¬›åº§</option>
                            <option value="åœ°å”„èˆ">åœ°å”„èˆ</option>
                            <option value="ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯">ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯</option>
                            <option value="æŒ¯è¢–å¸¯çµã³">æŒ¯è¢–å¸¯çµã³</option>
                            <option value="æŠ€è¡“æ™®åŠéƒ¨">æŠ€è¡“æ™®åŠéƒ¨</option>
                            <option value="ãƒ—ãƒ­ç€ä»˜é¤Šæˆ">ãƒ—ãƒ­ç€ä»˜é¤Šæˆ</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editCustomerTsumigi" />
                        <label for="editCustomerTsumigi">ç´¬å¥½ã</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editCustomerVIP" />
                        <label for="editCustomerVIP">VIP</label>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="saveCustomerEdit()">âœ… ä¿å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelEditCustomer()">âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>

                <div class="section-title">ğŸ“ è³¼å…¥å±¥æ­´</div>
                <div id="purchaseList"></div>

                <button class="btn btn-primary btn-large" onclick="showScreen('newPurchaseScreen')">
                    â• æ–°è¦è³¼å…¥ã‚’è¨˜éŒ²
                </button>
            </div>

            <!-- æ–°è¦è³¼å…¥ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="newPurchaseScreen" class="screen">
                <button class="back-button" onclick="showScreen('customerDetailScreen')">â† æˆ»ã‚‹</button>
                <h2>æ–°è¦è³¼å…¥ç™»éŒ²</h2>

                <div class="form-group">
                    <label>è³¼å…¥æ—¥ <span class="required">*</span></label>
                    <input type="date" id="newPurchaseDate" />
                </div>

                <div class="form-group">
                    <label>é‡‘é¡ <span class="required">*</span></label>
                    <input type="number" id="newPurchaseAmount" placeholder="ä¾‹ï¼š15000" />
                </div>

                <div class="form-group">
                    <label>å•†å“èª¬æ˜ <span class="required">*</span></label>
                    <textarea id="newPurchaseProduct" placeholder="å•†å“ã®èª¬æ˜ã‚’å…¥åŠ›..."></textarea>
                </div>

                <div class="section-title">ãƒ­ãƒ¼ãƒ³æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>

                <div class="form-group">
                    <label>ãƒ­ãƒ¼ãƒ³æ®‹é«˜</label>
                    <input type="number" id="newPurchaseLoanBalance" placeholder="ä¾‹ï¼š0" />
                </div>

                <div class="form-group">
                    <label>æ®‹ã‚Šæ”¯æ‰•ã„å›æ•°</label>
                    <input type="number" id="newPurchasePaymentCount" placeholder="ä¾‹ï¼š0" />
                </div>

                <div class="form-group">
                    <label>æœ€çµ‚æ”¯æ‰•ã„æœˆ</label>
                    <input type="month" id="newPurchaseFinalPayment" />
                </div>

                <div class="section-title">å±•ç¤ºä¼šæƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>

                <div class="form-group">
                    <label>è¥¿æš¦</label>
                    <input type="number" id="newPurchaseYear" placeholder="ä¾‹ï¼š2026" />
                </div>

                <div class="form-group">
                    <label>å±•ç¤ºä¼šç¨®åˆ¥</label>
                    <select id="newPurchaseExhibition">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ãŠã—ã‚ƒã‚Œåš">ãŠã—ã‚ƒã‚Œåš</option>
                        <option value="æ–°æ˜¥å±•">æ–°æ˜¥å±•</option>
                        <option value="è¯æ¯”ã¹">è¯æ¯”ã¹</option>
                        <option value="å­¦æ ¡ç¥­">å­¦æ ¡ç¥­</option>
                        <option value="ç‰¹åˆ¥å±•">ç‰¹åˆ¥å±•</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ãã®ä»–ã®å±•ç¤ºä¼šï¼ˆã€Œãã®ä»–ã€é¸æŠæ™‚ï¼‰</label>
                    <input type="text" id="newPurchaseExhibitionOther" placeholder="å±•ç¤ºä¼šåã‚’å…¥åŠ›..." />
                </div>

                <div class="section-title">å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>

                <div class="form-group">
                    <label>å•†å“è³¼å…¥ä¼ç¥¨å†™çœŸ</label>
                    <input type="file" id="newPurchasePhoto" accept="image/*" multiple onchange="previewPhotos()" />
                </div>

                <div class="gallery-container" id="photoPreview"></div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="savePurchase()">âœ… ç™»éŒ²ã™ã‚‹</button>
                    <button class="btn btn-secondary" onclick="showScreen('customerDetailScreen')">âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>

            <!-- å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ç”»é¢ -->
            <div id="photoGalleryScreen" class="screen">
                <button class="back-button" onclick="showScreen('customerDetailScreen')">â† æˆ»ã‚‹</button>
                <h2 id="galleryTitle">å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>

                <div class="gallery-container" id="fullGallery"></div>
            </div>

            <!-- ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ -->
            <div id="lightbox" class="lightbox">
                <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
                <div class="lightbox-content">
                    <img id="lightboxImage" class="lightbox-image" src="" />
                    <div class="lightbox-info" id="lightboxInfo"></div>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="previousPhoto()">â—€ï¸ å‰</button>
                        <button class="btn btn-secondary" onclick="nextPhoto()">æ¬¡ â–¶ï¸</button>
                    </div>
                </div>
            </div>

            <!-- V2.1 ãƒ„ãƒ¼ãƒ«ç”»é¢ -->
            <div id="toolsScreen" class="screen">
                <button class="back-button" onclick="showScreen('homeScreen')">â† æˆ»ã‚‹</button>
                <h2>ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ï¼†è¨­å®š</h2>

                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                    <button class="btn btn-primary btn-large" onclick="exportCustomersToCSV()">
                        ğŸ“‹ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary btn-large" onclick="exportPurchasesToCSV()">
                        ğŸ“Š è³¼å…¥å±¥æ­´ã‚’CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>

                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <div class="form-group">
                        <label>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
                        <input type="file" id="importCustomersFile" accept=".csv" />
                        <button class="btn btn-secondary btn-large" onclick="importCustomersFromCSV()" style="margin-top: 8px;">
                            â¬†ï¸ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                    <div class="form-group">
                        <label>è³¼å…¥å±¥æ­´ã‚’CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
                        <input type="file" id="importPurchasesFile" accept=".csv" />
                        <button class="btn btn-secondary btn-large" onclick="importPurchasesFromCSV()" style="margin-top: 8px;">
                            â¬†ï¸ è³¼å…¥å±¥æ­´ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">ğŸ“ˆ çµ±è¨ˆæƒ…å ±</h3>
                    <button class="btn btn-success btn-large" onclick="showStatistics()">
                        ğŸ“Š çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
                    </button>
                </div>

                <div style="margin-top: 24px; padding: 16px; background-color: var(--light-bg); border-radius: 8px;">
                    <p style="font-size: 12px; color: #6B7280; margin: 0;">
                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: CSVãƒ•ã‚¡ã‚¤ãƒ«ã¯Excelã‚„Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ãã“ã¨ãŒã§ãã¾ã™
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
        const StorageKey = {
            CUSTOMERS: 'customers',
            PURCHASES: 'purchases',
            PHOTOS: 'photos'
        };

        // ç¾åœ¨è¡¨ç¤ºä¸­ã®é¡§å®¢ID
        let currentCustomerId = null;
        let currentPurchaseId = null;
        let currentPhotoIndex = 0;
        let currentPhotos = [];

        // åˆæœŸåŒ–
        function init() {
            if (!localStorage.getItem(StorageKey.CUSTOMERS)) {
                localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify([]));
                localStorage.setItem(StorageKey.PURCHASES, JSON.stringify([]));
                localStorage.setItem(StorageKey.PHOTOS, JSON.stringify([]));
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                addSampleData();
            }
            setDefaultDate();
            renderCustomerList();
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        function addSampleData() {
            const sampleCustomers = [
                {
                    id: 'C001',
                    name: 'ç”°ä¸­å¤ªéƒ',
                    phone: '09012345678',
                    email: 'tanaka@example.com',
                    category: 'å€‹äººé¡§å®¢',
                    memo: 'ä¿¡é ¼ã§ãã‚‹å¸¸é€£é¡§å®¢',
                    vip: true,
                    createdDate: '2026-01-01'
                },
                {
                    id: 'C002',
                    name: 'ç”°ä¸­èŠ±å­',
                    phone: '09087654321',
                    email: 'hanako@example.com',
                    category: 'å€‹äººé¡§å®¢',
                    memo: '',
                    vip: false,
                    createdDate: '2026-01-10'
                }
            ];

            const samplePurchases = [
                {
                    id: 'P001',
                    customerId: 'C001',
                    date: '2026-01-20',
                    amount: 15000,
                    product: 'iPhone 15 Pro ã‚±ãƒ¼ã‚¹',
                    loanBalance: 0,
                    paymentCount: 0,
                    finalPayment: '',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'P002',
                    customerId: 'C001',
                    date: '2026-01-15',
                    amount: 8500,
                    product: 'ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹ã‚¤ãƒ¤ãƒ›ãƒ³',
                    loanBalance: 0,
                    paymentCount: 0,
                    finalPayment: '',
                    timestamp: new Date().toISOString()
                }
            ];

            localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify(sampleCustomers));
            localStorage.setItem(StorageKey.PURCHASES, JSON.stringify(samplePurchases));
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’æœ¬æ—¥ã«è¨­å®š
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('newPurchaseDate');
            if (dateInput) {
                dateInput.value = today;
            }
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'newPurchaseScreen') {
                setDefaultDate();
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // é¡§å®¢ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆè‡ªå‹•ã‚½ãƒ¼ãƒˆï¼‰
        function renderCustomerList() {
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const vipFilter = document.getElementById('vipFilter').checked;
            const tsumugiFilter = document.getElementById('tsumugiFilter').checked;
            const schoolFilter = document.getElementById('schoolFilter').value;
            const searchTerm = document.getElementById('homeSearch').value.toLowerCase();

            let filtered = customers.filter(c => {
                const matchesVIP = !vipFilter || c.vip;
                const matchesTsumigi = !tsumugiFilter || c.tsumigi;
                const matchesSchool = !schoolFilter || c.school === schoolFilter;
                const matchesSearch = c.name.toLowerCase().includes(searchTerm) || 
                                     c.phone.includes(searchTerm);
                return matchesVIP && matchesTsumigi && matchesSchool && matchesSearch;
            });

            // æ ¡æ¯ã®ã‚ã„ã†ãˆãŠé †ã«ã‚½ãƒ¼ãƒˆ
            filtered.sort((a, b) => {
                if (a.school !== b.school) {
                    return (a.school || '').localeCompare(b.school || '', 'ja');
                }
                return a.name.localeCompare(b.name, 'ja');
            });

            const listHtml = filtered.map(customer => {
                const visitCount = getPurchaseCount(customer.id);
                const lastVisit = getLastVisitDate(customer.id);

                return `
                    <div class="customer-card" onclick="viewCustomerDetail('${customer.id}')">
                        <div class="customer-card-header">
                            <div class="customer-name">
                                ${customer.vip ? '<span class="vip-badge">â­</span>' : ''}
                                ${customer.tsumigi ? '<span style="font-size: 16px; margin-right: 4px;">ğŸ§µ</span>' : ''}
                                ${customer.name}
                            </div>
                            <span class="visit-count">æ¥åº— ${visitCount}å›</span>
                        </div>
                        <div class="customer-info">ğŸ“ ${customer.school || 'â€”'}</div>
                        ${customer.phone ? `<div class="customer-info">ğŸ“ ${customer.phone}</div>` : ''}
                        ${lastVisit ? `<div class="customer-info">æœ€çµ‚æ¥åº—: ${lastVisit}</div>` : ''}
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="viewCustomerDetail('${customer.id}'); event.stopPropagation();">è©³ç´°</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('customerList').innerHTML = listHtml || 
                '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div>è©²å½“ã™ã‚‹é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            renderCustomerList();
        }

        // æ¥åº—å›æ•°ã‚’å–å¾—
        function getPurchaseCount(customerId) {
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            return purchases.filter(p => p.customerId === customerId).length;
        }

        // æœ€çµ‚æ¥åº—æ—¥ã‚’å–å¾—
        function getLastVisitDate(customerId) {
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const customerPurchases = purchases.filter(p => p.customerId === customerId);
            if (customerPurchases.length === 0) return null;
            const dates = customerPurchases.map(p => new Date(p.date));
            const latest = new Date(Math.max(...dates));
            return latest.toLocaleDateString('ja-JP');
        }

        // é¡§å®¢ã‚’ä¿å­˜
        function saveCustomer() {
            const name = document.getElementById('newCustomerName').value;

            if (!name) {
                alert('é¡§å®¢åã¯å¿…é ˆã§ã™');
                return;
            }

            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const newCustomer = {
                id: 'C' + String(customers.length + 1).padStart(3, '0'),
                name,
                phone: document.getElementById('newCustomerPhone').value,
                email: document.getElementById('newCustomerEmail').value,
                school: document.getElementById('newCustomerSchool').value,
                affiliation: document.getElementById('newCustomerAffiliation').value,
                category: document.getElementById('newCustomerCategory').value,
                memo: document.getElementById('newCustomerMemo').value,
                vip: document.getElementById('newCustomerVIP').checked,
                tsumigi: document.getElementById('newCustomerTsumigi')?.checked || false,
                createdDate: new Date().toISOString().split('T')[0]
            };

            customers.push(newCustomer);
            localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify(customers));

            alert('é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            resetCustomerForm();
            renderCustomerList();
            showScreen('homeScreen');
        }

        // é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetCustomerForm() {
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerPhone').value = '';
            document.getElementById('newCustomerEmail').value = '';
            document.getElementById('newCustomerSchool').value = '';
            document.getElementById('newCustomerAffiliation').value = '';
            document.getElementById('newCustomerCategory').value = '';
            document.getElementById('newCustomerMemo').value = '';
            document.getElementById('newCustomerVIP').checked = false;
            document.getElementById('newCustomerTsumigi').checked = false;
        }

        // ä¿®ç§‘ã‚’è¿½åŠ ï¼ˆã‚«ã‚¹ã‚¿ãƒ å€¤ï¼‰
        function addCustomCategory() {
            const newCategory = prompt('æ–°ã—ã„ä¿®ç§‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newCategory) {
                const select = document.getElementById('newCustomerCategory');
                const option = document.createElement('option');
                option.value = newCategory;
                option.textContent = newCategory;
                select.appendChild(option);
                select.value = newCategory;
                alert(`ã€Œ${newCategory}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            }
        }

        // é¡§å®¢è©³ç´°ã‚’è¡¨ç¤º
        function viewCustomerDetail(customerId) {
            currentCustomerId = customerId;
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const customer = customers.find(c => c.id === customerId);

            if (!customer) return;

            document.getElementById('detailCustomerName').textContent = 
                (customer.vip ? 'â­ ' : '') + customer.name;
            document.getElementById('detailCustomerPhone').textContent = customer.phone || 'â€”';
            document.getElementById('detailCustomerEmail').textContent = customer.email || 'â€”';
            document.getElementById('detailCustomerSchool').textContent = customer.school || 'â€”';
            document.getElementById('detailCustomerAffiliation').textContent = customer.affiliation || 'â€”';
            document.getElementById('detailCustomerCategory').textContent = customer.category || 'â€”';
            document.getElementById('detailVisitCount').textContent = getPurchaseCount(customerId);
            document.getElementById('detailLastVisit').textContent = getLastVisitDate(customerId) || 'â€”';
            document.getElementById('detailCreatedDate').textContent = 
                new Date(customer.createdDate).toLocaleDateString('ja-JP');

            renderPurchaseList();
            showScreen('customerDetailScreen');
            document.getElementById('editCustomerForm').style.display = 'none';
        }

        // é¡§å®¢ç·¨é›†ã‚’é–‹ã
        function editCustomer() {
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) return;

            document.getElementById('editCustomerName').value = customer.name;
            document.getElementById('editCustomerPhone').value = customer.phone || '';
            document.getElementById('editCustomerEmail').value = customer.email || '';
            document.getElementById('editCustomerSchool').value = customer.school || '';
            document.getElementById('editCustomerAffiliation').value = customer.affiliation || '';
            document.getElementById('editCustomerCategory').value = customer.category || '';
            document.getElementById('editCustomerVIP').checked = customer.vip || false;
            document.getElementById('editCustomerTsumigi').checked = customer.tsumigi || false;

            document.getElementById('editCustomerForm').style.display = 'block';
        }

        // é¡§å®¢ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEditCustomer() {
            document.getElementById('editCustomerForm').style.display = 'none';
        }

        // é¡§å®¢æƒ…å ±ã‚’ä¿å­˜
        function saveCustomerEdit() {
            const name = document.getElementById('editCustomerName').value;
            if (!name) {
                alert('é¡§å®¢åã¯å¿…é ˆã§ã™');
                return;
            }

            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) return;

            customer.name = name;
            customer.phone = document.getElementById('editCustomerPhone').value;
            customer.email = document.getElementById('editCustomerEmail').value;
            customer.school = document.getElementById('editCustomerSchool').value;
            customer.affiliation = document.getElementById('editCustomerAffiliation').value;
            customer.category = document.getElementById('editCustomerCategory').value;
            customer.vip = document.getElementById('editCustomerVIP').checked;
            customer.tsumigi = document.getElementById('editCustomerTsumigi').checked;

            localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify(customers));
            alert('é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            viewCustomerDetail(currentCustomerId);
            renderCustomerList();
        }

        // è³¼å…¥ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆæ–°ã—ã„é †ï¼‰
        function renderPurchaseList() {
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const customerPurchases = purchases.filter(p => p.customerId === currentCustomerId);

            // æ—¥ä»˜ãŒæ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            customerPurchases.sort((a, b) => new Date(b.date) - new Date(a.date));

            const listHtml = customerPurchases.map(purchase => {
                const photoCount = getPhotoCount(purchase.id);
                const exhibitionText = purchase.exhibition === 'ãã®ä»–' ? 
                    `ï¼ˆ${purchase.exhibitionOther}ï¼‰` : '';
                const exhibitionDisplay = purchase.exhibition ? 
                    `<div class="purchase-product">ğŸª å±•ç¤ºä¼š: ${purchase.year}å¹´ ${purchase.exhibition}${exhibitionText}</div>` : '';

                return `
                    <div class="purchase-item" onclick="viewPhotos('${purchase.id}')">
                        <div class="purchase-header">
                            <span class="purchase-date">${new Date(purchase.date).toLocaleDateString('ja-JP')}</span>
                            <span class="purchase-amount">Â¥${purchase.amount.toLocaleString()}</span>
                        </div>
                        <div class="purchase-product">${purchase.product}</div>
                        ${exhibitionDisplay}
                        ${purchase.loanBalance > 0 ? 
                            `<div class="purchase-product">ğŸ’³ ãƒ­ãƒ¼ãƒ³æ®‹é«˜: Â¥${purchase.loanBalance.toLocaleString()} (æ®‹${purchase.paymentCount}å›)</div>` 
                            : ''}
                        <div class="purchase-photos">
                            ğŸ“¸ ${photoCount}æšã®å†™çœŸ
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 8px; font-size: 12px; padding: 6px;" onclick="editPurchase('${purchase.id}'); event.stopPropagation();">
                            âœï¸ ç·¨é›†
                        </button>
                    </div>
                `;
            }).join('');

            document.getElementById('purchaseList').innerHTML = listHtml || 
                '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div>è³¼å…¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }

        // è³¼å…¥ã‚’ç·¨é›†
        function editPurchase(purchaseId) {
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const purchase = purchases.find(p => p.id === purchaseId);
            if (!purchase) return;

            document.getElementById('newPurchaseDate').value = purchase.date;
            document.getElementById('newPurchaseAmount').value = purchase.amount;
            document.getElementById('newPurchaseProduct').value = purchase.product;
            document.getElementById('newPurchaseLoanBalance').value = purchase.loanBalance || 0;
            document.getElementById('newPurchasePaymentCount').value = purchase.paymentCount || 0;
            document.getElementById('newPurchaseFinalPayment').value = purchase.finalPayment || '';
            document.getElementById('newPurchaseYear').value = purchase.year || '';
            document.getElementById('newPurchaseExhibition').value = purchase.exhibition || '';
            document.getElementById('newPurchaseExhibitionOther').value = purchase.exhibitionOther || '';

            currentPurchaseId = purchaseId;
            showScreen('newPurchaseScreen');
            document.querySelector('h2').textContent = 'è³¼å…¥å±¥æ­´ç·¨é›†';
        }

        // å†™çœŸæ•°ã‚’å–å¾—
        function getPhotoCount(purchaseId) {
            const photos = JSON.parse(localStorage.getItem(StorageKey.PHOTOS)) || [];
            return photos.filter(p => p.purchaseId === purchaseId).length;
        }

        // è³¼å…¥ã‚’ä¿å­˜
        function savePurchase() {
            const date = document.getElementById('newPurchaseDate').value;
            const amount = document.getElementById('newPurchaseAmount').value;
            const product = document.getElementById('newPurchaseProduct').value;

            if (!date || !amount || !product) {
                alert('è³¼å…¥æ—¥ã€é‡‘é¡ã€å•†å“èª¬æ˜ã¯å¿…é ˆã§ã™');
                return;
            }

            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            
            if (currentPurchaseId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const purchase = purchases.find(p => p.id === currentPurchaseId);
                if (purchase) {
                    purchase.date = date;
                    purchase.amount = parseInt(amount);
                    purchase.product = product;
                    purchase.loanBalance = parseInt(document.getElementById('newPurchaseLoanBalance').value) || 0;
                    purchase.paymentCount = parseInt(document.getElementById('newPurchasePaymentCount').value) || 0;
                    purchase.finalPayment = document.getElementById('newPurchaseFinalPayment').value;
                    purchase.year = document.getElementById('newPurchaseYear').value;
                    purchase.exhibition = document.getElementById('newPurchaseExhibition').value;
                    purchase.exhibitionOther = document.getElementById('newPurchaseExhibitionOther').value;
                }
                alert('è³¼å…¥å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            } else {
                // æ–°è¦ãƒ¢ãƒ¼ãƒ‰
                const newPurchase = {
                    id: 'P' + String(purchases.length + 1).padStart(3, '0'),
                    customerId: currentCustomerId,
                    date,
                    amount: parseInt(amount),
                    product,
                    loanBalance: parseInt(document.getElementById('newPurchaseLoanBalance').value) || 0,
                    paymentCount: parseInt(document.getElementById('newPurchasePaymentCount').value) || 0,
                    finalPayment: document.getElementById('newPurchaseFinalPayment').value,
                    year: document.getElementById('newPurchaseYear').value,
                    exhibition: document.getElementById('newPurchaseExhibition').value,
                    exhibitionOther: document.getElementById('newPurchaseExhibitionOther').value,
                    timestamp: new Date().toISOString()
                };

                purchases.push(newPurchase);
                
                // å†™çœŸã‚’ä¿å­˜
                const photoInput = document.getElementById('newPurchasePhoto');
                if (photoInput.files.length > 0) {
                    savePhotos(newPurchase.id, photoInput.files);
                }

                alert('è³¼å…¥å±¥æ­´ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            }

            localStorage.setItem(StorageKey.PURCHASES, JSON.stringify(purchases));
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('newPurchaseDate').value = '';
            document.getElementById('newPurchaseAmount').value = '';
            document.getElementById('newPurchaseProduct').value = '';
            document.getElementById('newPurchaseLoanBalance').value = '';
            document.getElementById('newPurchasePaymentCount').value = '';
            document.getElementById('newPurchaseFinalPayment').value = '';
            document.getElementById('newPurchaseYear').value = '';
            document.getElementById('newPurchaseExhibition').value = '';
            document.getElementById('newPurchaseExhibitionOther').value = '';
            document.getElementById('newPurchasePhoto').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            currentPurchaseId = null;

            document.querySelector('#newPurchaseScreen h2').textContent = 'æ–°è¦è³¼å…¥ç™»éŒ²';
            renderPurchaseList();
            showScreen('customerDetailScreen');
        }

        // å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function previewPhotos() {
            const input = document.getElementById('newPurchasePhoto');
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.innerHTML = `
                        <img src="${e.target.result}" />
                        <div class="gallery-item-counter">${index + 1}</div>
                    `;
                    preview.appendChild(item);
                };
                reader.readAsDataURL(file);
            });
        }

        // å†™çœŸã‚’ä¿å­˜
        function savePhotos(purchaseId, files) {
            const photos = JSON.parse(localStorage.getItem(StorageKey.PHOTOS)) || [];
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const purchase = purchases.find(p => p.id === purchaseId);

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const photo = {
                        id: 'IMG' + String(photos.length + 1).padStart(4, '0'),
                        purchaseId,
                        customerId: currentCustomerId,
                        url: e.target.result,
                        timestamp: new Date().toISOString(),
                        order: index
                    };
                    photos.push(photo);
                    localStorage.setItem(StorageKey.PHOTOS, JSON.stringify(photos));
                };
                reader.readAsDataURL(file);
            });
        }

        // å†™çœŸã‚’è¡¨ç¤º
        function viewPhotos(purchaseId) {
            currentPurchaseId = purchaseId;
            const photos = JSON.parse(localStorage.getItem(StorageKey.PHOTOS)) || [];
            currentPhotos = photos.filter(p => p.purchaseId === purchaseId).sort((a, b) => a.order - b.order);

            if (currentPhotos.length === 0) {
                alert('ã“ã®è³¼å…¥ã«é–¢ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const gallery = document.getElementById('fullGallery');
            gallery.innerHTML = currentPhotos.map((photo, index) => `
                <div class="gallery-item" onclick="openLightbox(${index})">
                    <img src="${photo.url}" />
                    <div class="gallery-item-counter">${index + 1}</div>
                </div>
            `).join('');

            showScreen('photoGalleryScreen');
        }

        // ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’é–‹ã
        function openLightbox(index) {
            currentPhotoIndex = index;
            const photo = currentPhotos[index];
            document.getElementById('lightboxImage').src = photo.url;
            document.getElementById('lightboxInfo').textContent = 
                `å†™çœŸ ${index + 1} / ${currentPhotos.length}`;
            document.getElementById('lightbox').classList.add('active');
        }

        // ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        // å‰ã®å†™çœŸ
        function previousPhoto() {
            if (currentPhotoIndex > 0) {
                openLightbox(currentPhotoIndex - 1);
            }
        }

        // æ¬¡ã®å†™çœŸ
        function nextPhoto() {
            if (currentPhotoIndex < currentPhotos.length - 1) {
                openLightbox(currentPhotoIndex + 1);
            }
        }

        // é¡§å®¢ã‚’ç·¨é›†
        function editCustomer() {
            alert('ç·¨é›†æ©Ÿèƒ½ã¯æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§è¿½åŠ äºˆå®šã§ã™');
        }

        // é¡§å®¢ã‚’å‰Šé™¤ï¼ˆç¢ºèªä»˜ãï¼‰
        function deleteCustomerConfirm() {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nï¼ˆé–¢é€£ã™ã‚‹è³¼å…¥å±¥æ­´ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) {
                return;
            }
            deleteCustomer();
        }

        // é¡§å®¢ã‚’å‰Šé™¤
        function deleteCustomer() {
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const photos = JSON.parse(localStorage.getItem(StorageKey.PHOTOS)) || [];

            // é–¢é€£ã™ã‚‹è³¼å…¥å±¥æ­´ã¨å†™çœŸã‚‚å‰Šé™¤
            const purchaseIds = purchases
                .filter(p => p.customerId === currentCustomerId)
                .map(p => p.id);

            const newCustomers = customers.filter(c => c.id !== currentCustomerId);
            const newPurchases = purchases.filter(p => p.customerId !== currentCustomerId);
            const newPhotos = photos.filter(p => !purchaseIds.includes(p.purchaseId));

            localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify(newCustomers));
            localStorage.setItem(StorageKey.PURCHASES, JSON.stringify(newPurchases));
            localStorage.setItem(StorageKey.PHOTOS, JSON.stringify(newPhotos));

            alert('é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            renderCustomerList();
            showScreen('homeScreen');
        }

        // æ¤œç´¢
        function searchCustomers() {
            renderCustomerList();
        }

        // ä¿®ç§‘ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒªã‚¹ãƒˆ
        const customCategories = [];

        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è¿½åŠ 
        function addCustomCategory() {
            const newCategory = prompt('æ–°ã—ã„ä¿®ç§‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newCategory && !customCategories.includes(newCategory)) {
                customCategories.push(newCategory);
                // ã™ã¹ã¦ã®ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
                updateCategorySelects();
                alert(`ã€Œ${newCategory}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°
        function updateCategorySelects() {
            const selects = [
                document.getElementById('newCustomerCategory'),
                document.getElementById('editCustomerCategory')
            ];

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’è¿½åŠ 
                customCategories.forEach(cat => {
                    if (!Array.from(select.options).some(opt => opt.value === cat)) {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        select.appendChild(option);
                    }
                });
            });
        }

        // ===== V2.1 æ–°æ©Ÿèƒ½ï¼šãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ =====

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCustomersToCSV() {
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            
            if (customers.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            const headers = ['é¡§å®¢ID', 'é¡§å®¢å', 'é›»è©±', 'ãƒ¡ãƒ¼ãƒ«', 'æ ¡å', 'æ‰€å±', 'ä¿®ç§‘', 'VIP', 'ç´¬å¥½ã', 'ç™»éŒ²æ—¥', 'æ¥åº—å›æ•°', 'åˆè¨ˆè³¼å…¥é¡'];
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            const rows = customers.map(customer => {
                const visitCount = purchases.filter(p => p.customerId === customer.id).length;
                const totalAmount = purchases
                    .filter(p => p.customerId === customer.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                return [
                    customer.id,
                    customer.name,
                    customer.phone || '',
                    customer.email || '',
                    customer.school || '',
                    customer.affiliation || '',
                    customer.category || '',
                    customer.vip ? 'ã¯ã„' : 'ã„ã„ãˆ',
                    customer.tsumigi ? 'ã¯ã„' : 'ã„ã„ãˆ',
                    new Date(customer.createdDate).toLocaleDateString('ja-JP'),
                    visitCount,
                    totalAmount.toLocaleString()
                ];
            });

            // CSVå½¢å¼ã§å‡ºåŠ›
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            downloadCSV(csv, 'é¡§å®¢ãƒ‡ãƒ¼ã‚¿_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        // è³¼å…¥å±¥æ­´ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportPurchasesToCSV() {
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            
            if (purchases.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹è³¼å…¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            const headers = ['è³¼å…¥ID', 'é¡§å®¢ID', 'é¡§å®¢å', 'è³¼å…¥æ—¥', 'é‡‘é¡', 'å•†å“èª¬æ˜', 'ãƒ­ãƒ¼ãƒ³æ®‹é«˜', 'å±•ç¤ºä¼š'];
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            const rows = purchases.map(purchase => {
                const customer = customers.find(c => c.id === purchase.customerId);
                const exhibition = purchase.exhibition ? 
                    `${purchase.year}å¹´ ${purchase.exhibition}${purchase.exhibitionOther ? 'ï¼ˆ' + purchase.exhibitionOther + 'ï¼‰' : ''}` 
                    : '';
                
                return [
                    purchase.id,
                    purchase.customerId,
                    customer?.name || 'â€”',
                    new Date(purchase.date).toLocaleDateString('ja-JP'),
                    purchase.amount.toLocaleString(),
                    purchase.product,
                    purchase.loanBalance || 'â€”',
                    exhibition || 'â€”'
                ];
            });

            // CSVå½¢å¼ã§å‡ºåŠ›
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            downloadCSV(csv, 'è³¼å…¥å±¥æ­´_' + new Date().toISOString().split('T')[0] + '.csv');
        }

        // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        function showStatistics() {
            const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
            const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];

            const totalCustomers = customers.length;
            const vipCustomers = customers.filter(c => c.vip).length;
            const tsumugiCustomers = customers.filter(c => c.tsumigi).length;
            const totalPurchases = purchases.length;
            const totalRevenue = purchases.reduce((sum, p) => sum + p.amount, 0);
            const averagePurchaseAmount = totalPurchases > 0 ? Math.floor(totalRevenue / totalPurchases) : 0;

            // æ ¡ã”ã¨ã®VIPé¡§å®¢æ•°
            const vipBySchool = {};
            customers.filter(c => c.vip).forEach(c => {
                const school = c.school || 'æœªè¨­å®š';
                vipBySchool[school] = (vipBySchool[school] || 0) + 1;
            });

            // æ ¡ã”ã¨ã®ç´¬å¥½ãäººæ•°
            const tsumugiBySchool = {};
            customers.filter(c => c.tsumigi).forEach(c => {
                const school = c.school || 'æœªè¨­å®š';
                tsumugiBySchool[school] = (tsumugiBySchool[school] || 0) + 1;
            });

            let stats = `ğŸ“Š çµ±è¨ˆæƒ…å ±\n\n`;
            stats += `é¡§å®¢ç·æ•°: ${totalCustomers}äºº\n`;
            stats += `è³¼å…¥è¨˜éŒ²æ•°: ${totalPurchases}ä»¶\n`;
            stats += `ç·å£²ä¸Š: Â¥${totalRevenue.toLocaleString()}\n`;
            stats += `å¹³å‡è³¼å…¥é¡: Â¥${averagePurchaseAmount.toLocaleString()}\n`;
            stats += `\nâ­ VIPé¡§å®¢: ${vipCustomers}äºº\n`;
            
            Object.keys(vipBySchool).sort().forEach(school => {
                stats += `  ${school}: ${vipBySchool[school]}äºº\n`;
            });

            stats += `\nğŸ§µ ç´¬å¥½ã: ${tsumugiCustomers}äºº\n`;
            
            Object.keys(tsumugiBySchool).sort().forEach(school => {
                stats += `  ${school}: ${tsumugiBySchool[school]}äºº\n`;
            });

            alert(stats);
        }

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCustomersFromCSV() {
            const file = document.getElementById('importCustomersFile').files[0];
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    
                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
                        return;
                    }

                    const customers = JSON.parse(localStorage.getItem(StorageKey.CUSTOMERS)) || [];
                    let importedCount = 0;
                    let skippedCount = 0;

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // CSVå½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
                        const cells = parseCSVLine(line);
                        
                        if (cells.length < 2) continue;

                        const customerId = cells[0];
                        const name = cells[1];

                        if (!name) continue;

                        // åŒã˜IDã®é¡§å®¢ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (customers.some(c => c.id === customerId)) {
                            skippedCount++;
                            continue;
                        }

                        const customer = {
                            id: customerId,
                            name: name,
                            phone: cells[2] || '',
                            email: cells[3] || '',
                            school: cells[4] || '',
                            affiliation: cells[5] || '',
                            category: cells[6] || '',
                            vip: cells[7]?.toLowerCase() === 'ã¯ã„',
                            tsumigi: cells[8]?.toLowerCase() === 'ã¯ã„',
                            createdDate: cells[9] || new Date().toISOString().split('T')[0],
                            memo: ''
                        };

                        customers.push(customer);
                        importedCount++;
                    }

                    localStorage.setItem(StorageKey.CUSTOMERS, JSON.stringify(customers));
                    document.getElementById('importCustomersFile').value = '';
                    
                    alert(`âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næ–°è¦è¿½åŠ : ${importedCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶`);
                    renderCustomerList();
                } catch (error) {
                    alert('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // è³¼å…¥å±¥æ­´ã‚’CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importPurchasesFromCSV() {
            const file = document.getElementById('importPurchasesFile').files[0];
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    
                    if (lines.length < 2) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™');
                        return;
                    }

                    const purchases = JSON.parse(localStorage.getItem(StorageKey.PURCHASES)) || [];
                    let importedCount = 0;
                    let skippedCount = 0;

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // CSVå½¢å¼ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
                        const cells = parseCSVLine(line);
                        
                        if (cells.length < 5) continue;

                        const purchaseId = cells[0];
                        const customerId = cells[1];
                        const amount = parseInt(cells[4]) || 0;

                        if (!purchaseId || !customerId || amount === 0) continue;

                        // åŒã˜IDã®è³¼å…¥ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        if (purchases.some(p => p.id === purchaseId)) {
                            skippedCount++;
                            continue;
                        }

                        const purchase = {
                            id: purchaseId,
                            customerId: customerId,
                            date: cells[3] || new Date().toISOString().split('T')[0],
                            amount: amount,
                            product: cells[5] || '',
                            loanBalance: parseInt(cells[6]) || 0,
                            paymentCount: 0,
                            finalPayment: '',
                            year: '',
                            exhibition: '',
                            exhibitionOther: '',
                            timestamp: new Date().toISOString()
                        };

                        purchases.push(purchase);
                        importedCount++;
                    }

                    localStorage.setItem(StorageKey.PURCHASES, JSON.stringify(purchases));
                    document.getElementById('importPurchasesFile').value = '';
                    
                    alert(`âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næ–°è¦è¿½åŠ : ${importedCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—: ${skippedCount}ä»¶`);
                } catch (error) {
                    alert('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // CSVè¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV(csv, filename) {
            const bom = '\uFEFF';
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', init);

        // ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹ï¼ˆå¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰
        document.getElementById('lightbox')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeLightbox();
            }
        });
    </script>
</body>
</html>
